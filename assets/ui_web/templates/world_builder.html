<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Builder - Genesis Mythos</title>
    <link rel="stylesheet" href="../css/world_builder.css">
</head>
<body>
    <div class="world-builder-container" x-data="worldBuilder">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1 class="title-label">World Builder ‚Äì Forging the World</h1>
        </div>

        <!-- Error Message Display -->
        <div x-show="errorMessage" class="error-message-container" style="background: rgba(200, 50, 50, 0.9); color: white; padding: 1rem; margin: 0.5rem; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <strong style="font-size: 1.1em; display: block; margin-bottom: 0.5rem;" x-text="errorMessage"></strong>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.9;" x-text="errorDetails"></p>
                </div>
                <button @click="errorMessage = null; errorDetails = null;" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.25rem 0.5rem; border-radius: 3px; cursor: pointer; margin-left: 1rem;">‚úï</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-hsplit">
            <!-- Left Panel: Numbered Tab Bar (BG3-style) -->
            <div class="left-tabs-panel">
                <div class="left-tabs-container">
                    <template x-for="(step, index) in steps" :key="index">
                        <button 
                            class="left-tab-button" 
                            :class="{ 'active': currentStep === index }"
                            @click="setStep(index)">
                            <span class="tab-number" x-text="index + 1"></span>
                            <span class="tab-label" x-text="step.title || `Step ${index + 1}`"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Center Panel: Azgaar Preview -->
            <!-- Azgaar is now rendered in a separate WebView node (WorldBuilderAzgaar) -->
            <!-- This panel is kept for layout consistency but the map is rendered by Godot WebView -->
            <div class="center-panel" style="background: #1a1a1a; display: flex; align-items: center; justify-content: center;">
                <p style="color: #888; font-style: italic;">Map preview rendered in separate WebView</p>
            </div>

            <!-- Right Panel: Parameters (Floating Panel Style) -->
            <div class="right-panel">
                <div class="right-outer-vbox">
                    <!-- Archetype Selector (Top) -->
                    <div class="archetype-selector">
                        <label>Archetype:</label>
                        <select x-model="archetype" @change="loadArchetype($event.target.value)">
                            <template x-for="arch in archetypeNames" :key="arch">
                                <option :value="arch" x-text="arch"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Seed Controls -->
                    <div class="seed-controls">
                        <label>Seed:</label>
                        <input 
                            type="number" 
                            x-model.number="seed" 
                            @change="setSeed(seed)"
                            :min="1" 
                            :max="999999999">
                        <button @click="randomizeSeed()" class="randomize-btn">üé≤</button>
                    </div>

                    <!-- Step Title -->
                    <div class="step-title-section">
                        <h2 class="step-title" x-text="currentStepTitle"></h2>
                    </div>

                    <!-- Parameters Tree (Step-specific curated parameters) -->
                    <div class="param-scroll">
                        <!-- Empty Step Info Text -->
                        <div x-show="currentStepParams.length === 0 && currentStepInfoText" class="empty-step-info">
                            <p class="info-text" x-text="currentStepInfoText"></p>
                        </div>
                        
                        <!-- Parameters List -->
                        <div class="param-list" x-show="currentStepParams.length > 0">
                            <template x-for="param in currentStepParams" :key="param.azgaar_key">
                                <div class="param-row">
                                    <label class="param-label" :title="param.description || ''" x-text="(param.name || param.azgaar_key).replace(/([A-Z])/g, ' $1').trim() + ':'"></label>
                                    <div class="param-control">
                                        <!-- OptionButton -->
                                        <template x-if="param.ui_type === 'OptionButton'">
                                            <select 
                                                x-model="params[param.azgaar_key]"
                                                @change="updateParam(param.azgaar_key, $event.target.value)">
                                                <template x-for="opt in param.options" :key="opt">
                                                    <option :value="opt" x-text="opt"></option>
                                                </template>
                                            </select>
                                        </template>

                                        <!-- HSlider -->
                                        <template x-if="param.ui_type === 'HSlider'">
                                            <div class="slider-container">
                                                <input 
                                                    type="range" 
                                                    x-model.number="params[param.azgaar_key]"
                                                    @input="updateParam(param.azgaar_key, parseFloat($event.target.value))"
                                                    :min="param.clamped_min !== undefined ? param.clamped_min : (param.min || 0)"
                                                    :max="param.clamped_max !== undefined ? param.clamped_max : (param.max || 100)"
                                                    :step="param.step || 1">
                                                <span class="slider-value" x-text="params[param.azgaar_key] || param.default || 0"></span>
                                            </div>
                                        </template>

                                        <!-- SpinBox -->
                                        <template x-if="param.ui_type === 'SpinBox'">
                                            <input 
                                                type="number" 
                                                x-model.number="params[param.azgaar_key]"
                                                @change="updateParam(param.azgaar_key, parseFloat($event.target.value))"
                                                :min="param.clamped_min !== undefined ? param.clamped_min : (param.min || 0)"
                                                :max="param.clamped_max !== undefined ? param.clamped_max : (param.max || 999999)"
                                                :step="param.step || 1">
                                        </template>

                                        <!-- CheckBox -->
                                        <template x-if="param.ui_type === 'CheckBox'">
                                            <input 
                                                type="checkbox" 
                                                x-model="params[param.azgaar_key]"
                                                @change="updateParam(param.azgaar_key, $event.target.checked)">
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Bar: Navigation -->
        <div class="bottom-bar">
            <div class="bottom-content">
                <div class="spacer-left"></div>
                <button @click="previousStep()" :disabled="currentStep === 0" class="nav-button">‚Üê Back</button>
                <button @click="generate()" class="nav-button generate-btn">‚ú® Generate / Apply Changes</button>
                <button @click="nextStep()" :disabled="currentStep >= totalSteps - 1" class="nav-button">Next ‚Üí</button>
                <div class="progress-section" x-show="isGenerating">
                    <progress :value="progressValue" max="100" class="progress-bar"></progress>
                    <span class="status-label" x-text="statusText"></span>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bridge.js"></script>
    <script src="../js/world_builder.js"></script>
    <script src="../js/alpine.min.js" defer></script>
</body>
</html>

